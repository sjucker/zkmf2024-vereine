<div>
  <app-header header="ZKMF2024 - Vereinsbereich"></app-header>
  <div class="loading-indicator">
    <mat-progress-bar mode="indeterminate" color="accent"
                      *ngIf="(!verein && !notFound && !error) || saving || confirming || uploading"></mat-progress-bar>
  </div>

  <div class="max-width-container" *ngIf="verein">
    <h2>Herzlich willkommen bei der Anmeldung für das ZKMF 2024</h2>
    <p class="button-container">
      <button mat-stroked-button color="primary" (click)="openInfoDialog()">Allgemeine Informationen</button>
      <button mat-flat-button color="primary"
              *ngIf="canConfirmRegistration()"
              [disabled]="unsavedChanges || confirming"
              (click)="confirmRegistration()">Definitiv anmelden
      </button>
    </p>
    <p>

    </p>
    <h2>
      Phase 1 (bis 30.06.2023)
      <app-phase-status [status]="verein.phase1Status"></app-phase-status>
    </h2>
    <mat-accordion>
      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <mat-panel-title>Vereinsangaben</mat-panel-title>
          <mat-panel-description>
            <app-validation-state [valid]="verein.angaben.valid"></app-validation-state>
          </mat-panel-description>
        </mat-expansion-panel-header>
        <div class="form-layout">
          <mat-form-field appearance="outline">
            <mat-label>Email</mat-label>
            <input type="email"
                   autocomplete="off"
                   matInput
                   [(ngModel)]="verein.email"
                   disabled="true">
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>Vereinsname</mat-label>
            <input type="text"
                   autocomplete="off"
                   matInput
                   [(ngModel)]="verein.angaben.vereinsname"
                   required
                   maxlength="255">
          </mat-form-field>
        </div>

        <div class="form-layout">
          <mat-form-field appearance="outline">
            <mat-label>Adresse</mat-label>
            <input type="text"
                   autocomplete="off"
                   matInput
                   [(ngModel)]="verein.angaben.adresse"
                   maxlength="255">
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>PLZ</mat-label>
            <input type="number"
                   autocomplete="off"
                   matInput
                   [(ngModel)]="verein.angaben.plz"
                   required
                   maxlength="4"
                   min="0" max="9999">
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>Ort</mat-label>
            <input type="text"
                   autocomplete="off"
                   matInput
                   [(ngModel)]="verein.angaben.ort"
                   required
                   maxlength="255">
          </mat-form-field>
        </div>
        <div class="form-layout">
          <mat-form-field appearance="outline">
            <mat-label>Homepage</mat-label>
            <input type="url"
                   autocomplete="off"
                   matInput
                   [(ngModel)]="verein.angaben.homepage"
                   maxlength="255">
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>PC/IBAN</mat-label>
            <input type="text"
                   autocomplete="off"
                   matInput
                   [(ngModel)]="verein.angaben.iban"
                   maxlength="255">
          </mat-form-field>
        </div>

        <div class="form-layout">
          <mat-checkbox [(ngModel)]="verein.angaben.direktionDoppeleinsatz"
                        (ngModelChange)="direktionDoppeleinsatzChanged($event)">
            Dirigent/in: Teilnahme mit einem weiteren Verein
          </mat-checkbox>
          <mat-form-field appearance="outline">
            <mat-label>Vereinsname</mat-label>
            <input type="text"
                   autocomplete="off"
                   matInput
                   [(ngModel)]="verein.angaben.direktionDoppeleinsatzVerein"
                   maxlength="255"
                   [disabled]="!verein.angaben.direktionDoppeleinsatz">
          </mat-form-field>
        </div>

        <div class="form-layout padding-bottom">
          <mat-checkbox [(ngModel)]="verein.angaben.mitspielerDoppeleinsatz">
            Musikant/innen: Doppelteilnahme <span class="mat-caption">(Doppelteilnahmen von Musikanten/Musikantinnen können nicht zwingend berücksichtigt werden!)</span>
          </mat-checkbox>
        </div>

        <app-action-button buttonLabel="Speichern"
                           [processing]="saving"
                           (buttonClicked)="saveVereinsangaben()"></app-action-button>
      </mat-expansion-panel>

      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <mat-panel-title>Anmeldung</mat-panel-title>
          <mat-panel-description>
            <app-validation-state [valid]="verein.anmeldung.valid"></app-validation-state>
          </mat-panel-description>
        </mat-expansion-panel-header>
        <div class="anmeldung-container">

          <div class="selection">
            <div><span class="mat-headline-6">Modul</span><br/>(mindestens ein Modul auswählen)</div>

            <mat-checkbox [(ngModel)]="verein.anmeldung.modulA"
                          [disabled]="anmeldungDisabled"
                          (ngModelChange)="onChange()">A - Konzertmusik
            </mat-checkbox>
            <mat-checkbox [(ngModel)]="verein.anmeldung.modulB"
                          [disabled]="anmeldungDisabled"
                          (ngModelChange)="onChange()">B - Unterhaltungsmusik
            </mat-checkbox>
            <mat-checkbox [(ngModel)]="verein.anmeldung.modulC"
                          [disabled]="anmeldungDisabled"
                          (ngModelChange)="onChange()">C - Platzkonzerte
            </mat-checkbox>
            <mat-checkbox [(ngModel)]="verein.anmeldung.modulD"
                          [disabled]="anmeldungDisabled"
                          (ngModelChange)="onChange()">D - Parademusik traditionell
            </mat-checkbox>
            <mat-checkbox [(ngModel)]="verein.anmeldung.modulE"
                          [disabled]="anmeldungDisabled"
                          (ngModelChange)="onChange()">E - Parademusik mit Evolutionen
            </mat-checkbox>
            <mat-checkbox [(ngModel)]="verein.anmeldung.modulF"
                          [disabled]="anmeldungDisabled"
                          (ngModelChange)="onChange()">F - Hallen-/Rasenshow
            </mat-checkbox>
            <mat-checkbox [(ngModel)]="verein.anmeldung.modulG"
                          [disabled]="anmeldungDisabled"
                          (ngModelChange)="onChange()">G - Tambouren
            </mat-checkbox>
            <mat-checkbox [(ngModel)]="verein.anmeldung.modulH"
                          [disabled]="anmeldungDisabled"
                          (ngModelChange)="onChange()">H - Perkussionsensembles
            </mat-checkbox>
          </div>
          <div class="selection">
            <div><span class="mat-headline-6">Stärkeklasse</span><br/>&nbsp;</div>
            <div
              *ngIf="!verein.anmeldung.modulA && !verein.anmeldung.modulB && !verein.anmeldung.modulH">
              Bitte ein entsprechendes Modul auswählen
            </div>
            <mat-form-field appearance="outline" *ngIf="verein.anmeldung.modulA">
              <mat-label>Stärkeklasse Modul A</mat-label>
              <mat-select [(ngModel)]="verein.anmeldung.klasseModulA" required
                          (ngModelChange)="onChange()"
                          [disabled]="anmeldungDisabled">
                <mat-option [value]="HOECHSTKLASSE">Höchstklasse</mat-option>
                <mat-option [value]="KLASSE_1">1. Klasse</mat-option>
                <mat-option [value]="KLASSE_2">2. Klasse</mat-option>
                <mat-option [value]="KLASSE_3">3. Klasse</mat-option>
                <mat-option [value]="KLASSE_4">4. Klasse</mat-option>
              </mat-select>
            </mat-form-field>
            <mat-form-field appearance="outline" *ngIf="verein.anmeldung.modulB">
              <mat-label>Stärkeklasse Modul B</mat-label>
              <mat-select [(ngModel)]="verein.anmeldung.klasseModulB" required
                          (ngModelChange)="onChange()"
                          [disabled]="anmeldungDisabled">
                <mat-option [value]="OBERSTUFE">Oberstufe</mat-option>
                <mat-option [value]="MITTELSTUFE">Mittelstufe</mat-option>
                <mat-option [value]="UNTERSTUFE">Unterstufe</mat-option>
              </mat-select>
            </mat-form-field>
            <mat-form-field appearance="outline" *ngIf="verein.anmeldung.modulH">
              <mat-label>Stärkeklasse Modul H</mat-label>
              <mat-select [(ngModel)]="verein.anmeldung.klasseModulH" required
                          (ngModelChange)="onChange()"
                          [disabled]="anmeldungDisabled">
                <mat-option [value]="OBERSTUFE">Oberstufe</mat-option>
                <mat-option [value]="MITTELSTUFE">Mittelstufe</mat-option>
                <mat-option [value]="UNTERSTUFE">Unterstufe</mat-option>
              </mat-select>
            </mat-form-field>
          </div>
          <div class="selection">
            <div><span class="mat-headline-6">Besetzung</span><br/>&nbsp;</div>
            <div *ngIf="noModulSelected">
              Bitte ein Modul auswählen
            </div>

            <mat-checkbox *ngIf="harmonieVisible"
                          [(ngModel)]="verein.anmeldung.harmonie"
                          (ngModelChange)="onChange()"
                          [disabled]="anmeldungDisabled || verein.anmeldung.brassBand || verein.anmeldung.fanfare">
              Harmonie
            </mat-checkbox>
            <mat-checkbox *ngIf="brassBandVisible"
                          [(ngModel)]="verein.anmeldung.brassBand"
                          (ngModelChange)="onChange()"
                          [disabled]="anmeldungDisabled || verein.anmeldung.harmonie || verein.anmeldung.fanfare">Brass
              Band
            </mat-checkbox>
            <mat-checkbox *ngIf="fanfareVisible"
                          [(ngModel)]="verein.anmeldung.fanfare"
                          (ngModelChange)="onChange()"
                          [disabled]="anmeldungDisabled || verein.anmeldung.harmonie || verein.anmeldung.brassBand">
              Fanfare
            </mat-checkbox>
            <mat-checkbox *ngIf="tambourenVisible"
                          [(ngModel)]="verein.anmeldung.tambouren"
                          (ngModelChange)="onChange()"
                          [disabled]="anmeldungDisabled">Tambouren
            </mat-checkbox>
            <mat-checkbox *ngIf="perkussionsensembleVisible"
                          [(ngModel)]="verein.anmeldung.perkussionsensemble"
                          (ngModelChange)="onChange()"
                          [disabled]="anmeldungDisabled">Perkussionsensemble
            </mat-checkbox>
          </div>
        </div>

        <app-action-button *ngIf="!anmeldungDisabled"
                           buttonLabel="Speichern"
                           [processing]="saving"
                           (buttonClicked)="saveAnmeldung()"></app-action-button>
      </mat-expansion-panel>

      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <mat-panel-title>Kontaktangaben - Präsident/in</mat-panel-title>
          <mat-panel-description>
            <app-validation-state [valid]="verein.praesident.valid"></app-validation-state>
          </mat-panel-description>
        </mat-expansion-panel-header>
        <app-kontakt-form [kontakt]="verein.praesident"></app-kontakt-form>

        <app-action-button buttonLabel="Speichern"
                           [processing]="saving"
                           (buttonClicked)="save()"></app-action-button>
      </mat-expansion-panel>

      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <mat-panel-title>Kontaktangaben - Dirigent/in</mat-panel-title>
          <mat-panel-description>
            <app-validation-state [valid]="verein.direktion.valid"></app-validation-state>
          </mat-panel-description>
        </mat-expansion-panel-header>
        <app-kontakt-form [kontakt]="verein.direktion"></app-kontakt-form>

        <app-action-button buttonLabel="Speichern"
                           [processing]="saving"
                           (buttonClicked)="save()"></app-action-button>
      </mat-expansion-panel>

      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <mat-panel-title>Vereinsinfo (Website)</mat-panel-title>
          <mat-panel-description>
            <app-validation-state [valid]="verein.info.valid"></app-validation-state>
          </mat-panel-description>
        </mat-expansion-panel-header>
        <mat-form-field appearance="outline" color="primary">
          <mat-label>Vorstellungstext</mat-label>
          <textarea matInput
                    cdkTextareaAutosize
                    cdkAutosizeMinRows="4"
                    cdkAutosizeMaxRows="10"
                    maxlength="4096"
                    required
                    [(ngModel)]="verein.info.websiteText"></textarea>
        </mat-form-field>
        <app-action-button buttonLabel="Speichern"
                           [processing]="saving"
                           (buttonClicked)="save()"></app-action-button>
        <div class="upload-container">
          <ngx-dropzone (change)="onDrop($event, true)"
                        [multiple]="false"
                        accept="image/jpeg,image/jpg"
                        [maxFileSize]="maxFileSize"
                        *ngIf="!verein.info.logoImgId">
            <ngx-dropzone-label>Vereinslogo (max. 1 MB)<br/>(Drag-and-Drop oder hier klicken)</ngx-dropzone-label>
            <ngx-dropzone-preview [removable]="true" (removed)="onRemove(true)" *ngIf="logo">
              <ngx-dropzone-label>{{ logo.name }} ({{ logo.type }})</ngx-dropzone-label>
            </ngx-dropzone-preview>
          </ngx-dropzone>

          <div *ngIf="verein.info.logoImgId" class="image-container">
            <mat-icon class="delete-image" color="primary"
                      (click)="deleteImage(verein.info.logoImgId)">delete
            </mat-icon>
            <img [src]="logoImgSrc" alt="Vereinslogo"/>
          </div>

          <ngx-dropzone (change)="onDrop($event, false)"
                        [multiple]="false"
                        accept="image/jpeg,image/jpg"
                        [maxFileSize]="maxFileSize"
                        *ngIf="!verein.info.bildImgId">
            <ngx-dropzone-label>Vereinsbild (max. 1 MB)<br/>(Drag-and-Drop oder hier klicken)</ngx-dropzone-label>
            <ngx-dropzone-preview [removable]="true" (removed)="onRemove(false)" *ngIf="bild">
              <ngx-dropzone-label>{{ bild.name }} ({{ bild.type }})</ngx-dropzone-label>
            </ngx-dropzone-preview>
          </ngx-dropzone>

          <div *ngIf="verein.info.bildImgId" class="image-container">
            <mat-icon class="delete-image" color="primary"
                      (click)="deleteImage(verein.info.bildImgId)">delete
            </mat-icon>
            <img [src]="bildImgSrc" alt="Vereinsbild"/>
          </div>

        </div>
      </mat-expansion-panel>
    </mat-accordion>

    <div *ngIf="verein.registrationConfirmed">
      <h2>
        Phase 2 (bis 16.09.2023)
        <app-phase-status [status]="verein.phase2Status"></app-phase-status>
      </h2>

      <mat-accordion>
        <mat-expansion-panel>
          <mat-expansion-panel-header>
            Selbstwahlstücke erfassen
          </mat-expansion-panel-header>
          <div class="form-layout">
            <mat-form-field appearance="outline">
              <mat-label>Titel*</mat-label>
              <input type="text"
                     autocomplete="off"
                     matInput
                     maxlength="255"
                     [(ngModel)]="newTitel.titelName">
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Komponist/in*</mat-label>
              <input type="text"
                     autocomplete="off"
                     matInput
                     maxlength="255"
                     [(ngModel)]="newTitel.composer">
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Arrangeur/in</mat-label>
              <input type="text"
                     autocomplete="off"
                     matInput
                     maxlength="255"
                     [(ngModel)]="newTitel.arrangeur">
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Dauer (z.B. 7:45)*</mat-label>
              <input type="text"
                     autocomplete="off"
                     matInput
                     [pattern]="durationPattern"
                     [(ngModel)]="newTitelDuration">
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Grad (1.0-6.0)*</mat-label>
              <input type="number"
                     autocomplete="off"
                     matInput
                     min="1.0"
                     max="6.0"
                     [pattern]="gradPattern"
                     [(ngModel)]="newTitel.grad">
            </mat-form-field>
            <div class="action-column">
              <button color="primary" mat-flat-button
                      [disabled]="!newTitelValid"
                      (click)="addNewTitel()">
                erfassen
              </button>
            </div>
          </div>

          <div *ngFor="let titel of verein.titel" class="form-layout">
            <div>{{titel.titelName}}</div>
            <div>{{titel.composer}}</div>
            <div>{{titel.arrangeur}}</div>
            <div>{{formatDuration(titel.durationInSeconds)}}</div>
            <div>{{titel.grad | number: '1.1-1'}}</div>
            <div class="action-column">
              <mat-icon color="primary" (click)="deleteTitel(titel)" class="clickable">delete</mat-icon>
            </div>
          </div>

          <app-action-button buttonLabel="Speichern"
                             [processing]="saving"
                             (buttonClicked)="save()"></app-action-button>
        </mat-expansion-panel>

        <mat-expansion-panel *ngFor="let programm of verein.programme; trackBy: trackById;" expanded>
          <mat-expansion-panel-header>
            Modul {{programm.modul}} - Programm erfassen
          </mat-expansion-panel-header>

          <p>
            <span *ngIf="programm.klasse"><b>Klasse</b>: {{programm.klasse}}<br/></span>
            <span *ngIf="programm.besetzung"><b>Besetzung</b>: {{programm.besetzung}}<br/></span>
            <span *ngIf="programm.minDurationInSeconds && programm.maxDurationInSeconds">
              <b>Vorgabe Dauer</b>: {{formatDuration(programm.minDurationInSeconds)}}
              - {{formatDuration(programm.maxDurationInSeconds)}}
            </span>
          </p>

          <table class="titel-table">
            <tr>
              <th></th>
              <th>Nr.</th>
              <th>Musikstück</th>
              <th>Dauer Stück</th>
              <th>Dauer Applaus (optional)</th>
              <th></th>
            </tr>
            <tr *ngFor="let entry of programm.ablauf; let i = index; let first = first; let last = last;">
              <td>
                <div *ngIf="first" class="spacer">&nbsp;</div>
                <mat-icon *ngIf="!first" (click)="moveUp(programm, entry)">arrow_upward</mat-icon>

                <mat-icon *ngIf="!last" (click)="moveDown(programm, entry)">arrow_downward</mat-icon>
                <div *ngIf="last" class="spacer">&nbsp;</div>
              </td>
              <td>{{i + 1}}</td>
              <td>{{entry.titel.titelName}} ({{entry.titel.composer}})</td>
              <td>{{formatDuration(entry.titel.durationInSeconds)}}</td>
              <td>
                <app-duration-input [durationInSeconds]="entry.applausInSeconds ?? 0"
                                    (valueChanged)="updateApplaus(programm, entry, $event)"></app-duration-input>
              </td>
              <td>
                <mat-icon color="primary" (click)="deleteProgrammTitel(programm, entry)" class="clickable">delete
                </mat-icon>
              </td>
            </tr>
          </table>

          <p>
            <b><span
              [ngClass]="{'valid': isInRange(programm)}">Total Dauer</span></b>: {{formatDuration(programm.totalDurationInSeconds)}}
            <br/>
            <span *ngIf="!isInRange(programm)"
                  class="invalid"><b>Differenz zur Vorgabe</b>: {{formatDuration(getDiffToVorgabe(programm))}}</span>
          </p>

          <div class="button-container">
            <mat-form-field appearance="outline">
              <mat-label>Stück</mat-label>
              <mat-select [(ngModel)]="selectedTitel">
                <mat-option *ngFor="let titel of programm.availableTitel" [value]="titel">{{titel.titelName}}
                  ({{titel.composer}})<span *ngIf="titel.pflichtStueck">*</span>
                </mat-option>
              </mat-select>
            </mat-form-field>

            <button color="primary" mat-flat-button
                    (click)="addNewProgrammTitel(programm)"
                    [disabled]="!selectedTitel">Hinzufügen
            </button>
          </div>

          <mat-form-field appearance="outline">
            <mat-label>Programmtitel</mat-label>
            <input type="text"
                   autocomplete="off"
                   matInput
                   [(ngModel)]="programm.titel"
                   maxlength="255"
                   required>
          </mat-form-field>

          <mat-form-field appearance="outline" color="primary">
            <mat-label>Informationen für die Moderation</mat-label>
            <textarea matInput
                      cdkTextareaAutosize
                      cdkAutosizeMinRows="4"
                      cdkAutosizeMaxRows="10"
                      maxlength="4096"
                      required
                      [(ngModel)]="programm.infoModeration"></textarea>
          </mat-form-field>

          <app-action-button buttonLabel="Speichern"
                             [processing]="saving"
                             (buttonClicked)="save()"></app-action-button>
        </mat-expansion-panel>
      </mat-accordion>
    </div>
  </div>

  <mat-card appearance="outlined" *ngIf="notFound">
    <mat-card-content>
      <p>Es wurde kein Verein für diesen Login gefunden.</p>
    </mat-card-content>
  </mat-card>

  <mat-card appearance="outlined" *ngIf="error">
    <mat-card-content>
      <p>Ein Fehler ist aufgetreten.</p>
    </mat-card-content>
  </mat-card>
</div>
